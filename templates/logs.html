{% extends 'layout.html' %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark">
                    <h2 class="card-title"><i class="fas fa-terminal me-2"></i>Container Logs</h2>
                </div>
                <div class="card-body">
                    {% if not docker_available %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Docker is not available in this environment. Container logs cannot be accessed.
                    </div>
                    {% else %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header {% if cluster1_status == 'running' %}bg-success{% else %}bg-secondary{% endif %}">
                                    <h5 class="card-title text-white mb-0">
                                        <i class="fas {% if cluster1_status == 'running' %}fa-check-circle{% else %}fa-times-circle{% endif %} me-2"></i>
                                        Cluster 1 ({{ config.cluster1.version }}) Logs
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <label for="cluster1Lines" class="form-label">Lines to display:</label>
                                                <select class="form-select form-select-sm d-inline-block w-auto me-2" id="cluster1Lines">
                                                    <option value="50">50</option>
                                                    <option value="100" selected>100</option>
                                                    <option value="200">200</option>
                                                    <option value="500">500</option>
                                                    <option value="1000">1000</option>
                                                </select>
                                            </div>
                                            <div>
                                                <button class="btn btn-primary btn-sm" id="refreshCluster1Logs">
                                                    <i class="fas fa-sync-alt"></i> Refresh
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="log-container bg-dark text-light p-3 rounded" style="height: 500px; overflow-y: auto;">
                                        <pre id="cluster1Logs" class="mb-0"><code>{% if cluster1_status != 'running' %}Cluster 1 is not running.{% else %}Loading logs...{% endif %}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header {% if cluster2_status == 'running' %}bg-success{% else %}bg-secondary{% endif %}">
                                    <h5 class="card-title text-white mb-0">
                                        <i class="fas {% if cluster2_status == 'running' %}fa-check-circle{% else %}fa-times-circle{% endif %} me-2"></i>
                                        Cluster 2 ({{ config.cluster2.version }}) Logs
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <label for="cluster2Lines" class="form-label">Lines to display:</label>
                                                <select class="form-select form-select-sm d-inline-block w-auto me-2" id="cluster2Lines">
                                                    <option value="50">50</option>
                                                    <option value="100" selected>100</option>
                                                    <option value="200">200</option>
                                                    <option value="500">500</option>
                                                    <option value="1000">1000</option>
                                                </select>
                                            </div>
                                            <div>
                                                <button class="btn btn-primary btn-sm" id="refreshCluster2Logs">
                                                    <i class="fas fa-sync-alt"></i> Refresh
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="log-container bg-dark text-light p-3 rounded" style="height: 500px; overflow-y: auto;">
                                        <pre id="cluster2Logs" class="mb-0"><code>{% if cluster2_status != 'running' %}Cluster 2 is not running.{% else %}Loading logs...{% endif %}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Associated Containers Logs -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-cubes me-2"></i>Associated Containers
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="card-title mb-0">PostgreSQL for Cluster 1</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-2">
                                                        <button class="btn btn-sm btn-primary" id="refreshPgCluster1Logs">
                                                            <i class="fas fa-sync-alt"></i> Refresh
                                                        </button>
                                                    </div>
                                                    <div class="log-container bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto;">
                                                        <pre id="pgCluster1Logs" class="mb-0"><code>Loading logs...</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="card-title mb-0">PostgreSQL for Cluster 2</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-2">
                                                        <button class="btn btn-sm btn-primary" id="refreshPgCluster2Logs">
                                                            <i class="fas fa-sync-alt"></i> Refresh
                                                        </button>
                                                    </div>
                                                    <div class="log-container bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto;">
                                                        <pre id="pgCluster2Logs" class="mb-0"><code>Loading logs...</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="card-title mb-0">MinIO for Cluster 1</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-2">
                                                        <button class="btn btn-sm btn-primary" id="refreshMinioCluster1Logs">
                                                            <i class="fas fa-sync-alt"></i> Refresh
                                                        </button>
                                                    </div>
                                                    <div class="log-container bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto;">
                                                        <pre id="minioCluster1Logs" class="mb-0"><code>Loading logs...</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="card-title mb-0">MinIO for Cluster 2</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-2">
                                                        <button class="btn btn-sm btn-primary" id="refreshMinioCluster2Logs">
                                                            <i class="fas fa-sync-alt"></i> Refresh
                                                        </button>
                                                    </div>
                                                    <div class="log-container bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto;">
                                                        <pre id="minioCluster2Logs" class="mb-0"><code>Loading logs...</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="card-title mb-0">Iceberg REST for Cluster 1</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-2">
                                                        <button class="btn btn-sm btn-primary" id="refreshIcebergCluster1Logs">
                                                            <i class="fas fa-sync-alt"></i> Refresh
                                                        </button>
                                                    </div>
                                                    <div class="log-container bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto;">
                                                        <pre id="icebergCluster1Logs" class="mb-0"><code>Loading logs...</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="card-title mb-0">Iceberg REST for Cluster 2</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-2">
                                                        <button class="btn btn-sm btn-primary" id="refreshIcebergCluster2Logs">
                                                            <i class="fas fa-sync-alt"></i> Refresh
                                                        </button>
                                                    </div>
                                                    <div class="log-container bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto;">
                                                        <pre id="icebergCluster2Logs" class="mb-0"><code>Loading logs...</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Function to fetch logs
    function fetchLogs(containerName, elementId, lines) {
        if (!containerName) {
            $(`#${elementId}`).html('<code>Container not specified</code>');
            return;
        }
        
        $.ajax({
            url: `/api/container_logs/${containerName}`,
            method: 'GET',
            data: { lines: lines },
            success: function(response) {
                if (response.logs) {
                    // Escape HTML to prevent XSS
                    const escapedLogs = response.logs
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    
                    $(`#${elementId}`).html(`<code>${escapedLogs}</code>`);
                    
                    // Scroll to bottom
                    const container = document.getElementById(elementId).parentElement;
                    container.scrollTop = container.scrollHeight;
                } else {
                    $(`#${elementId}`).html('<code>No logs available</code>');
                }
            },
            error: function(xhr) {
                let errorMessage = 'Error fetching logs';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                $(`#${elementId}`).html(`<code class="text-danger">${errorMessage}</code>`);
            }
        });
    }

    // Initialize logs if containers are running
    {% if cluster1_status == 'running' %}
    fetchLogs('{{ config.cluster1.container_name }}', 'cluster1Logs', $('#cluster1Lines').val());
    {% endif %}
    
    {% if cluster2_status == 'running' %}
    fetchLogs('{{ config.cluster2.container_name }}', 'cluster2Logs', $('#cluster2Lines').val());
    {% endif %}
    
    // Fetch PostgreSQL logs
    fetchLogs('postgres-for-{{ config.cluster1.container_name }}', 'pgCluster1Logs', 50);
    fetchLogs('postgres-for-{{ config.cluster2.container_name }}', 'pgCluster2Logs', 50);
    
    // Fetch MinIO logs
    fetchLogs('minio-for-{{ config.cluster1.container_name }}', 'minioCluster1Logs', 50);
    fetchLogs('minio-for-{{ config.cluster2.container_name }}', 'minioCluster2Logs', 50);
    
    // Fetch Iceberg REST logs
    fetchLogs('iceberg-rest-for-{{ config.cluster1.container_name }}', 'icebergCluster1Logs', 50);
    fetchLogs('iceberg-rest-for-{{ config.cluster2.container_name }}', 'icebergCluster2Logs', 50);

    // Set up refresh buttons
    $('#refreshCluster1Logs').click(function() {
        fetchLogs('{{ config.cluster1.container_name }}', 'cluster1Logs', $('#cluster1Lines').val());
    });
    
    $('#refreshCluster2Logs').click(function() {
        fetchLogs('{{ config.cluster2.container_name }}', 'cluster2Logs', $('#cluster2Lines').val());
    });
    
    $('#refreshPgCluster1Logs').click(function() {
        fetchLogs('postgres-for-{{ config.cluster1.container_name }}', 'pgCluster1Logs', 50);
    });
    
    $('#refreshPgCluster2Logs').click(function() {
        fetchLogs('postgres-for-{{ config.cluster2.container_name }}', 'pgCluster2Logs', 50);
    });
    
    $('#refreshMinioCluster1Logs').click(function() {
        fetchLogs('minio-for-{{ config.cluster1.container_name }}', 'minioCluster1Logs', 50);
    });
    
    $('#refreshMinioCluster2Logs').click(function() {
        fetchLogs('minio-for-{{ config.cluster2.container_name }}', 'minioCluster2Logs', 50);
    });
    
    $('#refreshIcebergCluster1Logs').click(function() {
        fetchLogs('iceberg-rest-for-{{ config.cluster1.container_name }}', 'icebergCluster1Logs', 50);
    });
    
    $('#refreshIcebergCluster2Logs').click(function() {
        fetchLogs('iceberg-rest-for-{{ config.cluster2.container_name }}', 'icebergCluster2Logs', 50);
    });
    
    // Update logs when line count changes
    $('#cluster1Lines').change(function() {
        fetchLogs('{{ config.cluster1.container_name }}', 'cluster1Logs', $(this).val());
    });
    
    $('#cluster2Lines').change(function() {
        fetchLogs('{{ config.cluster2.container_name }}', 'cluster2Logs', $(this).val());
    });
});
</script>
{% endblock %}