{% extends "layout.html" %}

{% block title %}Simple Trino Version Comparison{% endblock %}

{% block scripts %}
<script>
// Store versions in JavaScript variable
const trino_versions = {{ versions_json|safe }};
console.log("Total versions available:", trino_versions.length);

$(document).ready(function() {
    // Populate the version dropdowns
    populateVersionDropdowns();
    
    // Handle form submission via AJAX to prevent page reload
    $('#version-comparison-form').on('submit', function(e) {
        e.preventDefault();
        
        // Get the submit button
        const compareButton = $('#compare-versions-btn');
        
        // Disable the button to prevent duplicate submissions
        compareButton.prop('disabled', true);
        
        // Hide results and error messages
        $('#results-content').hide();
        $('#error-message').hide();
        $('#version-range-info').hide();
        
        // Show loading message
        $('#comparison-results').prepend('<div id="inline-loading" class="alert alert-info"><i class="fas fa-sync fa-spin me-2"></i> Loading comparison results...</div>');
        
        // Get selected versions
        const fromVersion = $('#from_version').val();
        const toVersion = $('#to_version').val();
        
        console.log("Form submitted with versions:", fromVersion, "to", toVersion);
        
        // Submit form via AJAX
        $.ajax({
            url: "{{ url_for('simple_compare.compare_versions') }}",
            type: 'POST',
            data: $(this).serialize(),
            dataType: 'json',
            success: function(response) {
                // Debug info
                console.log("Response received:", response);
                
                // Remove the loading message
                $('#inline-loading').remove();
                
                // Re-enable the button
                compareButton.prop('disabled', false);
                
                if (!response.success) {
                    $('#error-text').text(response.message || 'An error occurred while comparing versions.');
                    $('#error-message').show();
                    return;
                }
                
                // Show success info
                console.log("Successfully received data:");
                console.log("- Connector changes:", response.connector_changes ? response.connector_changes.length : 0);
                console.log("- General changes:", response.general_changes ? response.general_changes.length : 0);
                
                // Update version range info
                $('#version-range-text').html(`${response.from_version} to ${response.to_version}`);
                $('#version-range-info').show();
                
                // Reset counters and clear content
                $('#connector-count').text('0');
                $('#general-count').text('0');
                $('#connector-changes-list').empty();
                $('#general-changes-list').empty();
                
                // Process connector changes
                if (response.connector_changes && response.connector_changes.length > 0) {
                    $('#connector-count').text(response.connector_changes.length);
                    $('#no-connector-changes').hide();
                    
                    // Group changes by connector category
                    const connectorGroups = {};
                    for (let i = 0; i < response.connector_changes.length; i++) {
                        const change = response.connector_changes[i];
                        if (!connectorGroups[change.category]) {
                            connectorGroups[change.category] = [];
                        }
                        connectorGroups[change.category].push(change);
                    }
                    
                    // Render connector changes by group
                    let accordionIndex = 0;
                    for (const category in connectorGroups) {
                        const changes = connectorGroups[category];
                        const categoryName = category.replace('#', '').trim();
                        const categoryTitle = categoryName.charAt(0).toUpperCase() + categoryName.slice(1);
                        
                        // Create accordion group for this connector
                        const accordionItem = $('<div class="accordion-item"></div>');
                        const headerId = `connector-heading-${accordionIndex}`;
                        const collapseId = `connector-collapse-${accordionIndex}`;
                        
                        // Create header
                        const header = $(`
                            <h2 class="accordion-header" id="${headerId}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                    <strong>${categoryTitle}</strong> <span class="badge bg-primary ms-2">${changes.length}</span>
                                </button>
                            </h2>
                        `);
                        
                        // Create body
                        const body = $(`
                            <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headerId}" data-bs-parent="#connector-changes-list">
                                <div class="accordion-body">
                                </div>
                            </div>
                        `);
                        
                        // Add changes to body
                        const bodyContent = body.find('.accordion-body');
                        for (let j = 0; j < changes.length; j++) {
                            const change = changes[j];
                            const changeItem = $(`
                                <div class="change-item mb-3" data-version="${change.version}">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-grow-1">
                                            <h5 class="mb-1">${change.title}</h5>
                                            <span class="badge bg-secondary mb-2">Version ${change.version}</span>
                                            <p>${change.description}</p>
                                        </div>
                                    </div>
                                </div>
                            `);
                            bodyContent.append(changeItem);
                        }
                        
                        // Add header and body to accordion item
                        accordionItem.append(header).append(body);
                        
                        // Add accordion item to connector changes list
                        $('#connector-changes-list').append(accordionItem);
                        
                        accordionIndex++;
                    }
                } else {
                    $('#no-connector-changes').show();
                }
                
                // Process general changes
                if (response.general_changes && response.general_changes.length > 0) {
                    $('#general-count').text(response.general_changes.length);
                    $('#no-general-changes').hide();
                    
                    // Group general changes by category (if available)
                    const generalGroups = {};
                    for (let i = 0; i < response.general_changes.length; i++) {
                        const change = response.general_changes[i];
                        const category = change.category || 'General';
                        if (!generalGroups[category]) {
                            generalGroups[category] = [];
                        }
                        generalGroups[category].push(change);
                    }
                    
                    // Render general changes by group
                    let accordionIndex = 0;
                    for (const category in generalGroups) {
                        const changes = generalGroups[category];
                        const categoryName = category.replace('#', '').trim();
                        const categoryTitle = categoryName.charAt(0).toUpperCase() + categoryName.slice(1);
                        
                        // Create accordion group
                        const accordionItem = $('<div class="accordion-item"></div>');
                        const headerId = `general-heading-${accordionIndex}`;
                        const collapseId = `general-collapse-${accordionIndex}`;
                        
                        // Create header
                        const header = $(`
                            <h2 class="accordion-header" id="${headerId}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                    <strong>${categoryTitle}</strong> <span class="badge bg-secondary ms-2">${changes.length}</span>
                                </button>
                            </h2>
                        `);
                        
                        // Create body
                        const body = $(`
                            <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headerId}" data-bs-parent="#general-changes-list">
                                <div class="accordion-body">
                                </div>
                            </div>
                        `);
                        
                        // Add changes to body
                        const bodyContent = body.find('.accordion-body');
                        for (let j = 0; j < changes.length; j++) {
                            const change = changes[j];
                            const changeItem = $(`
                                <div class="change-item mb-3" data-version="${change.version}">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-grow-1">
                                            <h5 class="mb-1">${change.title}</h5>
                                            <span class="badge bg-secondary mb-2">Version ${change.version}</span>
                                            <p>${change.description}</p>
                                        </div>
                                    </div>
                                </div>
                            `);
                            bodyContent.append(changeItem);
                        }
                        
                        // Add header and body to accordion item
                        accordionItem.append(header).append(body);
                        
                        // Add accordion item to general changes list
                        $('#general-changes-list').append(accordionItem);
                        
                        accordionIndex++;
                    }
                } else {
                    $('#no-general-changes').show();
                }
                
                // Show the results
                $('#results-content').show();
            },
            error: function(xhr, status, error) {
                console.error("AJAX error:", status, error);
                $('#inline-loading').remove();
                compareButton.prop('disabled', false);
                $('#error-text').text('Failed to communicate with the server. Please try again.');
                $('#error-message').show();
            }
        });
    });
    
    // Add expand/collapse functionality for accordion sections
    $('#connector-expand-all').click(function() {
        $('#connector-changes-list .accordion-collapse').collapse('show');
    });
    
    $('#connector-collapse-all').click(function() {
        $('#connector-changes-list .accordion-collapse').collapse('hide');
    });
    
    $('#general-expand-all').click(function() {
        $('#general-changes-list .accordion-collapse').collapse('show');
    });
    
    $('#general-collapse-all').click(function() {
        $('#general-changes-list .accordion-collapse').collapse('hide');
    });
    
    // Search functionality for connector changes
    $('#connector-search').on('keyup', function() {
        const searchText = $(this).val().toLowerCase();
        filterChanges('#connector-changes-list', searchText);
    });
    
    // Search functionality for general changes
    $('#general-search').on('keyup', function() {
        const searchText = $(this).val().toLowerCase();
        filterChanges('#general-changes-list', searchText);
    });
});

// Function to populate version dropdowns
function populateVersionDropdowns() {
    // Get the select elements
    const fromVersionSelect = document.getElementById('from_version');
    const toVersionSelect = document.getElementById('to_version');
    
    // Clear existing options
    fromVersionSelect.innerHTML = '';
    toVersionSelect.innerHTML = '';
    
    // Add options for each version
    trino_versions.forEach(version => {
        const fromOption = document.createElement('option');
        fromOption.value = version.version;
        fromOption.textContent = version.version;
        if (version.version === '{{ from_version }}') {
            fromOption.selected = true;
        }
        
        const toOption = document.createElement('option');
        toOption.value = version.version;
        toOption.textContent = version.version;
        if (version.version === '{{ to_version }}') {
            toOption.selected = true;
        }
        
        fromVersionSelect.appendChild(fromOption);
        toVersionSelect.appendChild(toOption);
    });
}

// Function to filter changes based on search text
function filterChanges(containerSelector, searchText) {
    // If search is empty, show all change items
    if (searchText === '') {
        $(`${containerSelector} .change-item`).show();
        $(`${containerSelector} .accordion-item`).show();
        return;
    }
    
    // Hide all accordion items first
    $(`${containerSelector} .accordion-item`).hide();
    
    // Iterate through each change item
    $(`${containerSelector} .change-item`).each(function() {
        const itemText = $(this).text().toLowerCase();
        
        // Show/hide based on search match
        if (itemText.includes(searchText)) {
            $(this).show();
            // Show the parent accordion item
            $(this).closest('.accordion-item').show();
            // Expand the parent accordion
            $(this).closest('.accordion-collapse').collapse('show');
        } else {
            $(this).hide();
        }
    });
}
</script>
{% endblock %}

{% block header_css %}
<style>
    .version-select-container {
        max-width: 800px;
        margin: 0 auto;
    }
    #results-content {
        margin-top: 30px;
    }
    .change-item p {
        white-space: pre-wrap;
    }
    .code {
        font-family: monospace;
        background-color: #f5f5f5;
        padding: 2px 4px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block header_scripts %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>
                        Simple Trino Version Changes Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <div class="version-select-container">
                        <form id="version-comparison-form">
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                Compare changes between two Trino versions to see what's new, changed, or removed.
                            </div>
                            
                            <div class="row g-3 align-items-center">
                                <div class="col-5">
                                    <div class="form-group">
                                        <label for="from_version" class="form-label">From Version</label>
                                        <select class="form-select" id="from_version" name="from_version" required>
                                            <!-- Options will be populated by JavaScript -->
                                        </select>
                                    </div>
                                </div>
                                <div class="col-2 text-center" style="padding-top: 30px;">
                                    <i class="fas fa-arrow-right fa-2x"></i>
                                </div>
                                <div class="col-5">
                                    <div class="form-group">
                                        <label for="to_version" class="form-label">To Version</label>
                                        <select class="form-select" id="to_version" name="to_version" required>
                                            <!-- Options will be populated by JavaScript -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid mt-3">
                                <button type="submit" class="btn btn-primary" id="compare-versions-btn">
                                    <i class="fas fa-sync-alt me-2"></i>
                                    Compare Versions
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="alert alert-info mt-4" id="version-range-info" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        Showing changes for versions <span id="version-range-text"></span>
                    </div>
                    
                    <div id="comparison-results" class="mt-4">                    
                    <div id="results-content" style="display: none;">
                        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="connector-tab" data-bs-toggle="tab" data-bs-target="#connector" type="button" role="tab" aria-controls="connector" aria-selected="true">
                                    <i class="fas fa-plug me-1"></i> Connector Changes <span id="connector-count" class="badge bg-primary ms-1">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="false">
                                    <i class="fas fa-cogs me-1"></i> General Changes <span id="general-count" class="badge bg-secondary ms-1">0</span>
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content p-3 border border-top-0 rounded-bottom" id="resultTabsContent">
                            <!-- Connector Changes Tab -->
                            <div class="tab-pane fade show active" id="connector" role="tabpanel" aria-labelledby="connector-tab">
                                <div class="d-flex justify-content-between mb-3">
                                    <div>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" id="connector-search" class="form-control" placeholder="Search connector changes...">
                                        </div>
                                    </div>
                                    <div>
                                        <button id="connector-expand-all" class="btn btn-sm btn-outline-primary me-2">
                                            <i class="fas fa-expand-alt me-1"></i> Expand All
                                        </button>
                                        <button id="connector-collapse-all" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-compress-alt me-1"></i> Collapse All
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mb-3" id="no-connector-changes" style="display: none;">
                                    <i class="fas fa-info-circle me-2"></i> No connector changes found between these versions.
                                </div>
                                
                                <div id="connector-changes-list" class="accordion"></div>
                            </div>
                            
                            <!-- General Changes Tab -->
                            <div class="tab-pane fade" id="general" role="tabpanel" aria-labelledby="general-tab">
                                <div class="d-flex justify-content-between mb-3">
                                    <div>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" id="general-search" class="form-control" placeholder="Search general changes...">
                                        </div>
                                    </div>
                                    <div>
                                        <button id="general-expand-all" class="btn btn-sm btn-outline-primary me-2">
                                            <i class="fas fa-expand-alt me-1"></i> Expand All
                                        </button>
                                        <button id="general-collapse-all" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-compress-alt me-1"></i> Collapse All
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mb-3" id="no-general-changes" style="display: none;">
                                    <i class="fas fa-info-circle me-2"></i> No general changes found between these versions.
                                </div>
                                
                                <div id="general-changes-list" class="accordion"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="error-message" class="alert alert-danger mt-3" style="display: none;">
                        <i class="fas fa-exclamation-circle me-2"></i> <span id="error-text"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}